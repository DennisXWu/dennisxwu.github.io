---
title: 深入理解计算机系统（10）—文件系统
date: 2021-2-3 23:29:53
categories:
- 操作系统
tags:
- 操作系统
---

## 1、磁盘设备分区

### 1.1、分区类型

 磁盘的分区主要分为**基本分区（primary partion）**和**扩充分区(extension partion)**两种，基本分区和扩充分区的数目之和**不能大于四个**。且基本分区可以马上被使用但不能再分区。**扩充分区必须再进行分区后才能使用**，也就是说它必须还要进行二次分区。那么由扩充分区再分下去的是什么呢？它就是**逻辑分区（logical partion）**，况且逻辑分区**没有数量上限制**。

- **基本分区（primary partion）**

基本分区也称主分区，引导分区、每块磁盘分区**主分区与扩展分区加起来不能大于四个**。

基本分区创建后可以立即使用，但是有分区数量上限。

- **扩充分区(extension partion)**

每块磁盘内只能划分**一块扩展分区**

扩展分区内可划分任意块逻辑分区

扩展分区创建后不能直接使用，需要在扩展分区内创建逻辑分区

- **逻辑分区（logical partion）**

 逻辑分区实在扩展分区内创建的分区

 逻辑分区相当与一块存储介质，和其他逻辑分区主分区完全独立

### 1.2、磁盘类型

- **IDE硬盘**

  驱动器标识符为hdx

  IDE硬盘最多64个分区

  其中“hdx~”表明分区所在设备的类型、hd 表示ide、x表示哪块盘、~表示分区号

- **SCSI硬盘**

  驱动器标识符为sdx

  其中“sdx~”表明分区所在设备的类型、sd 表示sde、x表示哪块盘、~表示分区号

- **hda1、hda2、hda3、hda5、hda6**

  Linux中规定每块硬盘最多4个主分区（包含扩展分区）任何占用分区都要占用分区号

  主分区（包含扩展分区分区号）：1 ~ 4 结束。如：hda1、hda2、hda3

  逻辑分区：5 ~ 16 结束。如：hda5、hda6 ..

- **hda、hdb、hdc、hdd**

  增一块按磁盘后面按字母顺序名称

  a为基本盘，b为基本从属盘，c为辅助主盘，d为辅助从属盘

## 2、文件类型

### 2.1、普通文件

​    使用 ls -l 命令后，第一列第一个字符为 "-" 的文件为普通文件，如上图所示，普通文件一般为灰色字体，绿色字体的是可执行文件，红色字体的是压缩文件。

**文件的权限：**

　　以普通文件为例，使用 ls -l 命令，可以看到结果的第一列是 **-rwxrwxrwx** 的形式，其中第一个字符 "-" 表示这个文件为普通文件，它也可以是其他的字符，不同的字符代表不同类型的文件。其后的一串字符表明了该文件的权限，其中：

1）r 表明该文件具有可读权限，若该位置为 "-" ，则表明文件不可读；

2）w 表明该文件具有写权限，若该位置为 "-" ，则表明文件不可写；

3）x 表明该文件具有可执行权限，若该位置为 "-" ，则表明文件不具有可执行权限；

4）第一个 rwx 表示该文件的所有者对该文件的权限；第二个 rwx 表示该文件所属组对该文件的权限；第三个 rwx 表示其他用户对该文件的权限。

### 2.2、目录文件

​      Linux 中的目录也是文件，目录文件中保存着该目录下其他文件的 inode 号 和文件名等信息，目录文件中的每个数据项都是指向某个文件 inode 号的链接，删除文件名就等于删除与之对应的链接。目录文件的字体颜色是蓝色，使用 ls -l 命令查看，第一个字符为"d"（directory）。

**目录文件的权限**：

1）r 表明该目录文件具有可读权限，即可以使用 ls 命令查看该目录的存储情况；

2）w 表明该目录文件具有写权限，即可以往该目录下添加、修改、删除文件；

3）x 表明该目录文件具有可执行文件，即可以使用 cd 命令进入到该目录下。

### 2.3、连接文件

链接文件一般指的是一个文件的软连接（或符号链接），使用 ls -l 命令查看，第一个符号为 "l"，文件名为浅蓝色，如下：

![img]({{ site.url }}/assets/img/Linux/7.1.png)

 　这里，test_softlink 就是一个链接文件，从结果上还可以看到它是文件 test.txt 的软链接，删除原文件 test.txt 的话，对应的软链接文件 test_softlink 也会消失。可以使用 ln 命令来创建一个文件的链接文件：

**1）软链接**

　　软链接（又称符号链接），使用 **ln -s file file_softlink** 命令可以创建一个文件的软链接文件：

```shell
ln -s test.txt test_softlink
```

　　软链接相当于给原文件创建了一个快捷方式，如果删除原文件，则对应的软链接文件也会消失。

**2）硬链接**

　　硬链接，相当于给原文件取了个别名，其实两者是同一个文件，删除二者中任何一个，另一个不会消失；对其中任何一个进行更改，另一个的内容也会随之改变，因为这两个本质上是同一个文件，只是名字不同。使用 ls -i 命令查看，可以发现硬链接的两个文件的 inode 号是一样的：

![img]({{ site.url }}/assets/img/Linux/7.2.png)

　　同样的，使用 ln 命令可以创建一个文件的硬链接：

```shell
ln test.txt test_hardlink
```

### 2.4、设备文件

　Linux 中的硬件设备如硬盘、鼠标等也都被表示为文件，即为设备文件。设备文件一般存放在 /dev/ 目录下，文件名为黄色，如下：

![img]({{ site.url }}/assets/img/Linux/7.3.png)

设备文件分两种：

**1）块设备文件：**

　　块设备文件支持以块（block）为单位的访问方式。在 EXT4 文件系统中，一个 block 通常为 4KB 的大小，也就是说每次可以存取 4096（或其整数倍） 个字节的数据。应用程序可以随机访问块设备文件的数据，程序可以自行确定数据的位置，硬盘、软盘等都是块设备。使用 ls -l 命令查看，块设备文件的第一个字符是 "b"（block）。

**2）字符设备文件：**

　　字符设备文件以字节流的方式进行访问，由字符设备驱动程序来实现这种特性，这通常要用到 open、close、read、write 等系统调用。字符终端、串口和键盘等就是字符设备。另外，由于字符设备文件是以文件流的方式进行访问的，因此可以顺序读取，但通常不支持随机存取。使用 ls -l 命令查看，字符设备文件的第一个字符是 "c"（char）。

### 2.5、管道文件（FIFO文件）

管道文件主要用于进程间通信，使用 ls -l 命令查看，第一个字符为 "p"（pipe）。可以使用 mkfifo 命令来创建一个管道文件：

```shell
mkfifo fifo_file
```

![img]({{ site.url }}/assets/img/Linux/7.4.png)

　　在 FIFO 中可以很好地解决在无关进程间数据交换的要求，FIFO 的通信方式类似于在进程中使用文件来传输数据，只不过 FIFO 类型的文件同时具有管道的特性，在读取数据时，FIFO 管道中同时清除数据。 

## 3、用户空间和内核空间

### 3.1、什么是用户和内核空间？

​      对 32 位操作系统而言，它的寻址空间（虚拟地址空间，或叫线性地址空间）为 4G（2的32次方）。也就是说一个进程的最大地址空间为 4G。操作系统的核心是内核(kernel)，它独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。**为了保证内核的安全，现在的操作系统一般都强制用户进程不能直接操作内核。**具体的实现方式基本都是由操作系统**将虚拟地址空间划分为两部分，一部分为内核空间，另一部分为用户空间。**针对 Linux 操作系统而言，最高的 1G 字节(从虚拟地址 0xC0000000 到 0xFFFFFFFF)由内核使用，称为内核空间。而较低的 3G 字节(从虚拟地址 0x00000000 到 0xBFFFFFFF)由各个进程使用，称为用户空间。
对上面这段内容我们可以这样理解：
**每个进程的 4G 地址空间中，最高 1G 都是一样的，即内核空间。只有剩余的 3G 才归进程自己使用。**
**换句话说就是， 最高 1G 的内核空间是被所有进程共享的！**

![image]({{ site.url }}/assets/img/Linux/7.5.png)

### 3.2、为什么要区分内核用户空间？

​    在 CPU 的所有指令中，有些指令是非常危险的，如果错用，将导致系统崩溃，比如**清内存、设置时钟**等。如果允许所有的程序都可以使用这些指令，那么系统崩溃的概率将大大增加。
​    所以，CPU 将指令分为特权指令和非特权指令，对于那些危险的指令，只允许操作系统及其相关模块使用，普通应用程序只能使用那些不会造成灾难的指令。比如 Intel 的 CPU 将特权等级分为 4 个级别：Ring0~Ring3。
​    其实 Linux 系统只使用了 Ring0 和 Ring3 两个运行级别(Windows 系统也是一样的)。当进程运行在 Ring3 级别时被称为运行在用户态，而运行在 Ring0 级别时被称为运行在内核态。

- **用户态**

  在用户态下，进程运行在**用户地址空间**中，被执行的代码要受到 CPU 的诸多检查，它们只能访问映射其地址空间的页表项中规定的在用户态下可访问页面的虚拟地址，且只能对任务状态段(TSS)中 I/O 许可位图(I/O Permission Bitmap)中规定的可访问端口进行直接访问。

- **内核态**

   在内核态下，进程运行在**内核地址空间**中，此时 CPU 可以执行任何指令。运行的代码也不受任何的限制，可以自由地访问任何有效地址，也可以直接进行端口的访问。

   对于 Linux 来说，通过区分内核空间和用户空间的设计，隔离了操作系统代码(操作系统的代码要比应用程序的代码健壮很多)与应用程序代码。即便是单个应用程序出现错误也不会影响到操作系统的稳定性，这样其它的程序还可以正常的运行(Linux 可是个多任务系统啊！)。

**所以，区分内核空间和用户空间本质上是要提高操作系统的稳定性及可用性。**

### 3.3、**如何从用户态进入内核态**

​     其实所有的系统资源管理都是在内核空间中完成的。比如**读写磁盘文件，分配回收内存，从网络接口读写数据**等等。我们的应用程序是无法直接进行这样的操作的。但是我们可以**通过内核提供的接口**来完成这样的任务。

​     应用程序要读取磁盘上的一个文件，它可以向内核发起一个 "系统调用" 告诉内核："我要读取磁盘上的某某文件"。其实就是**通过一个特殊的指令让进程从用户态进入到内核态(到了内核空间)**。在内核空间中，CPU 可以执行任何的指令，当然也包括从磁盘上读取数据。具体过程是**先把数据读取到内核空间中**，然后**再把数据拷贝到用户空间并从内核态切换到用户态**。此时应用程序已经从系统调用中返回并且拿到了想要的数据

## 4、文件系统

文件系统粗略的分类：

![image]({{ site.url }}/assets/img/Linux/7.6.png)

### 4.1、根文件系统

根文件系统`（rootfs）`是内核启动时所 mount(挂载)的第一个文件系统，内核代码映像文件保存在根文件系中，而系统引导启动程序会在根文件系统挂载之后从中把一些基本的初始化脚本和服务等加载到内存中去运行。

根文件系统的根目录`/`下有很多子目录：

![image]({{ site.url }}/assets/img/Linux/7.7.png)

### 4.2、虚拟文件系统

​    从上面的分类图中我们可以知道Linux中有很多文件系统，并且是共存的。那么在Linux中是怎么做到让一切都是文件呢？这是由于有一层虚拟文件系统软件抽象层的存在，这个软件抽象层为用户屏蔽了底层文件系统的差异，向上层提供了统一地访问接口。如图：

![image]({{ site.url }}/assets/img/Linux/7.8.png)

​	无论最下层的文件系统是什么，我们最上层的用户端尽管使用系统调用接口（open、write、read等）或glibc接口（fopen、fwrite、fread等）来操作就可访问文件系统里的文件，使得一切都是文件成为可能。

### 4.3、真文件系统

真文件系统其实是实际存储设备的文件系统，挂载于EEPROM、 Nor FLASH、 NAND FLASH、 eMMC 等存储器中。

**1、ext2**

   EXT2第二代扩展文件系统（second extended filesystem，缩写为 ext2），是Linux内核早期所用的文件系统，但是随着技术的发展 ext2 文件系统已经不推荐使用了。ext2是一个非日志文件系统。

**2、ext3**

EXT3是第三代扩展文件系统（Third extended filesystem，缩写为ext3），是一个日志文件系统。主要特点：

- 高可用性：系统使用了ext3文件系统后，即使在非正常关机后，系统也不需要检查文件系统。宕机发生后，恢复ext3文件系统的时间只要数十秒钟。
- 数据完整性：ext3文件系统能够极大地提高文件系统的完整性，避免了意外宕机对文件系统的破坏。

**3、ext4**

EXT4是第四代扩展文件系统（Fourth extended filesystem，缩写为 ext4）是一个日志文件系统，是ext3文件系统的后继版本。主要特点：

- 更多的子目录数量：Ext3目前只支持32000个子目录，而Ext4取消了这一限制，理论上支持无限数量的子目录。
- 更多的块和i-节点数量：Ext3文件系统使用32位空间记录块数量和i-节点数量，而Ext4文件系统将它们扩充到64位。

### 4.4、伪文件系统

​    Linux内核提供了sysfs、procfs、devtmpfs等伪文件系统，**伪文件系统存在于内存，不占用硬盘**。以文件地形式向用户提供一些系统信息，用户读写这些文件就可以读取、修改系统的一些信息。

**1、procfs**

procfs是 进程文件系统的缩写，包含一个伪文件系统（启动时动态生成的文件系统），用于**通过内核访问进程信息**。这个文件系统通常被挂载到 /proc 目录。

由于 /proc 不是一个真正的文件系统，它也就不占用存储空间，只是占用有限的内存。

/proc目录的内容如下：

![image]({{ site.url }}/assets/img/Linux/7.9.png)

其中，这些以数字命名的文件夹就是与进程相关的部分，这些数字就是进程的PID号。

**2、sysfs**

sysfs是一个基于内存的文件系统，它的作用是将**内核信息以文件的方式提供给用户程序使用**。sysfs 文件系统被挂载在 /sys 挂载点上。/sys目录下的内容如：

![image]({{ site.url }}/assets/img/Linux/7.10.png)

**3、devtmpfs**

devtmpfs 的功用是在 Linux 核心启动早期建立一个初步的 /dev，令一般启动程序不用等待 udev（udev 是Linux kernel 2.6系列的设备管理器。它主要的功能是管理/dev目录底下的设备节点。），缩短 GNU/Linux 的开机时间。

## 5、交换空间

### 5.1、什么是交换空间？

​      交换空间（Swap Space)，有时候也被称为虚拟内存，是硬盘中划出来的一段虚拟内存空间，用于扩展操作系统的物理内存。当系统的物理内存不够用的时候，操作系统把内存中最不常用的数据“交换”到交换空间，从而将物理内存中的一部分空间释放出来供其他程序使用。当程序需要用到交换空间内的数据的时候，操作系统再将数据从交换分区恢复到物理内存中。

Linux操作系统有两种实现交换空间的方法：**交换分区（swap分区）**和**交换文件（swap文件）**。

 Linux下有两种类型的swap空间，swap分区和swap文件，他们有各自的特点：
1、swap 分区上面由于没有文件系统，所以相当于内核直接访问连续的磁盘空间，效率相对要高点，但由于swap分区一般安装系统时就分配好了了，后期要缩减空间和扩容都很不方便。
2、swap 文件放在指定分区的文件系统里面，所以有可能受文件系统性能的影响，但据说2.6版本以后的内核可以直接访问swap文件对应的物理磁盘地址，相当于跳过了文件系统直接访问磁盘，不过如果swap文件在磁盘上的物理位置不连续时，还是会对性能产生不利影响，但其优点就是灵活，随时可以增加和移除swap文件。 

### 5.2、swap大小设置多少？

| Amount of RAM in the system 物理内存 | Recommended swap space建议的交换空间大小 | Recommended swap space if allowing for hibernation如果开启休眠功能建议的交换空间大小 |
| ------------------------------------ | ---------------------------------------- | ------------------------------------------------------------ |
| ⩽ 2GB                                | 2 times the amount of RAM                | 3 times the amount of RAM                                    |
| > 2GB – 8GB                          | Equal to the amount of RAM               | 2 times the amount of RAM                                    |
| > 8GB – 64GB                         | At least 4 GB                            | 1.5 times the amount of RAM                                  |
| > 64GB                               | At least 4 GB                            | Hibernation not recommended                                  |

