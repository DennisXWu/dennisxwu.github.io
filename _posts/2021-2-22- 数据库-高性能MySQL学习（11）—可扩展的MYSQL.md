---
title: 高性能MySQL学习（11）—可扩展的MYSQL
date: 2021-2-22 23:29:53
categories:
- 数据库
tags:
- 数据库
---

## 1、什么是可扩展性

可扩展性。 即通过增加资源提升整个系统吞吐量的能力

一般会有如下的角度影响负载：
- 数据量
- 用户量 更多的用户，意味着更多的数据，更复杂的查询，更多的事务
- 用户活跃度 容易造成热点
- 相关数据集的大小 即关联数据，比如好友

可扩展性的数学表现：
- 最简单的是线性的，资源翻倍，吞吐量翻倍
- 但是由于有些工作是线性的，无法通过并发来提升，这样曲线就会趋于平缓
- 再引入扩展带来的内部节点或者是线程间的通信，会造成曲线的不降反升
- 考虑到有一些I/O密集型的应用，扩展只会可能变成全都读取内存，还有可能造成曲线上扬

## 2、扩展mysql

通常系统初建时要考虑一点可扩展性。在扩展之前，要先压榨单机性能，比如算法调优等等

### 2.1 向上扩展（**Scale Up**）

向上扩展（也叫垂直扩展）就是换CPU，磁盘等等。对部分应用来说这是唯一需要做的。

**优点：**
- 单台服务器比多台服务器更加容易开发和维护，能显著节省开销
- 在单台服务器上备份和恢复应用同样简单；
- 无需关心一致性；

为了能够更好的在大型服务器上运行MySQL,一定要尽量使用最新的版本。
如果应用变得非常庞大，向上扩展可能就没有办法。

### 2.2 向外扩展（Scale Out）

向外扩展有时也称为**横向扩展**或者**水平扩展**，策略划分为三个部分：**复制、拆分**，以及**数据分片（sharding）**。

最常见的向外扩展就是**读写分离**。通过**复制**将数据分发到多个服务器上，然后将备库用于读查询。这种技术对于以读为主的应用很有效。

另一个比较常见的向外扩展方法是**将工作负载分布到多个 “节点”**。接下来我们要了解的主要是这种扩展方法。

在此之前，我们先明确下节点的概念。在 MySQL 架构中，一个节点就是一个功能部件。一般的，我们会将一台服务器作为一个几点。但如果我们考虑到节点的高可用性，那么一个节点通常可能是下面的几种：
- 一个主 - 主 复制双机结构，拥有一个主动服务器和被动服务器。
- 一个主库和多个备库。
- 一个主动服务器，并使用分布式复制块设备（DRBD）作为备用服务器。
- 一个基于存储区域网络（SAN）的 “集群”。

#### 2.2.1、按功能拆分

按功能拆分，或者说按职责拆分，意味着不同的节点执行不同的任务。

例如，如果有一个网站，各个部分无需共享数据，那么可以按照网站的功能区域进行划分。像我们常见的门户网站，一般都是把不同栏目放在一起，但实际上可以将网站新闻、论坛、寻求支持等功能放到专用的 MySQL 服务器。如图：

![img]({{ site.url }}/assets/img/数据库/11.1.webp)

#### 2.2.2、数据分片

Sharding 是把**数据库横向扩展（Scale Out）到多个物理节点**上的一种有效的方式，其主要**目的是为突破单节点数据库服务器的 I/O 能力限制**，解决数据库扩展性问题。Shard这个词的意思是“碎片”。如果将一个数据库当作一块大玻璃，将这块玻璃打碎，那么每一小块都称为数据库的碎片。将整个数据库打碎的过程就叫做sharding，可以翻译为分片。

>  **一个shard可以包含多个表的内容甚至可以包含多个数据库实例中的内容**。每个shard被放置在一个数据库服务器上。**一个数据库服务器可以处理一个或多个shard的数据**。系统中需要有服务器进行查询路由转发，负责将查询转发到包含该查询所访问数据的shard或shards节点上去执行。

MySql的Sharding策略包括垂直切分和水平切分两种：

**垂直(纵向)拆分：**是指按功能模块拆分，以解决表与表之间的io竞争。比如分为订单库、商品库、用户库...这种方式多个数据库之间的表结构不同。

表结构设计垂直切分。常见的一些场景包括：
a). 大字段的垂直切分。单独将大字段建在另外的表中，提高基础表的访问性能，原则上在性能关键的应用中应当避免数据库的大字段
b). 按照使用用途垂直切分。例如企业物料属性，可以按照基本属性、销售属性、采购属性、生产制造属性、财务会计属性等用途垂直切分
c). 按照访问频率垂直切分。例如电子商务、Web 2.0系统中，如果用户属性设置非常多，可以将基本、使用频繁的属性和不常用的属性垂直切分开

**水平(横向)拆分：**将同一个表的数据进行分块保存到不同的数据库中，来解决单表中数据量增长出现的压力。这些数据库中的表结构完全相同。

表结构设计水平切分。常见的一些场景包括：
a). 比如在线电子商务网站，订单表数据量过大，按照年度、月度水平切分
b). Web 2.0网站注册用户、在线活跃用户过多，按照用户ID范围等方式，将相关用户以及该用户紧密关联的表做水平切分
c). 例如论坛的置顶帖子，因为涉及到分页问题，每页都需要显示置顶贴，这种情况可以把置顶贴水平切分开来，避免取置顶帖子时从所有帖子的表中读取

### 2.3、通过多实例扩展

上面提到过，MySQL 不能完全发挥现代硬件的性能。当扩展到超过 24 个 CPU 核心时，MySQL 的性能开始趋于平缓，不再上升。当内存超过 128G 时也同样如此。对于此种情况，我们可以通过**多实例策略**充分发挥硬件的性能。

多实例策略的基本思路是：
1. 数据分片足够小，可以使得在每台机器上都能放置多个分片；
2. 每台服务器运行多个实例；
3. 给每个实例划分服务器的硬件资源；

可以看出，这是一种向上扩展和向外扩展的组合方案。这种方案还可以通过**将每个 MySQL 实例绑定到特定的 CPU 核心上**来优化性能。这种优化，主要有两个好处：
1. 由于 MySQL 内部的可扩展性限制，当核心数较少时，能够在每个核心上获得更好的性能；
2. 当实例在多个核心上运行线程时，由于需要在多核心上同步共享数据，因而会有额外的开销。

而我们把实例和 CPU 核心绑定后，可以减少 CPU 核心直接的切换和交互。要注意的，将进程绑定到具有相同物理套接字的核心上可以获得最优的效果。

### 2.4、向内扩展

对于不断增长的数据和负载，最简单的方法是对不再需要的数据进行归档和清理。这种操作可能会带来显著的效果。这种做法并不能代替其他策略，但可以作为争取时间的短期策略，也可以作为处理大数据量的长期计划之一。

在设计归档和清理策略时需要考虑如下几点：
1. **对应用的影响**。设计良好的归档系统能够在不影响事务处理的情况下，从一个高负债的 OLTP 服务器上移除数据。
2. **要归档的行**。考虑清楚哪些数据可以清理或归档。
3. **维护数据一致性**。数据间存在联系时，归档任务系统要能够保证数据的逻辑一致性。
4. **避免数据丢失**。归档时要保证归档数据已经成功保存，再讲源数据删除。
5. **解除归档**。考虑清楚归档系统中的解除归档策略。可以通过设置一些检查点让系统检查是否有需要归档的数据。

如果不能及时的把老数据归档和清理时，我们也可以通过以下隔离冷热数据的方式来提高性能：
1. **将表划分为几个部分**。分割大表中的冷热数据，保证加载到内存中的数据中，热数据的比例；
2. **MySQL 分区**。使用MySQL 自带的分区的功能，可以帮助我们把最近的数据留在内存中；
3. **基于时间的数据分区**。如果应用不断有新数据尽量，一般新数据总是比旧数据更加活跃。因此，我们可以将新数据完整的保留在内存中，同时使用复制来保证主库失效时有一份可以的备份，而旧数据就而言放到别的地方。

## 3、负载均衡

前端负载均衡器，根据服务器性能情况分发请求。
目的： 更有效的使用资源。 可用性提高(保证有服务有用)， 透明。
跟分片和复制关系密切，可以部署在任何一个环节，比如应用前端，数据库前端等
可选的方案： DNS, LVS, TCP代理等等。普遍使用F5， HAProxy

### 3.1、直接连接

应用直连。不使用中间件完全用业务来判断负载，如选择不同的备库做不同的逻辑。
1. **读写分离**
   写用主库，读用主备分担，实时性的用主库，其他用备库
   让应用检查复制延迟，提高容忍脏数据的能力
   基于会话，自己修改的数据查看时查主库。
   基于版本，查看下备库的时间戳版本类型的字段查看下如果太旧就查主库
2. **修改DNS**
   比较粗的方式，把主库和备库绑定在不同的DNS中，然后切换。但是因为不是原子的，会被缓存等等原因并不是很好用。

### 3.2、引入中间件

1. 负载均衡器
   1.一般的负载均衡器都是HTTP协议的，但是Mysql需要TCP协议的，因此要使用能支持TCP协议的，但是这不是专门为Mysql设计的，还是会有一些限制。
   不能很好的均衡，因为无法知道负载权重
   2.均衡器并不能很好的分辨Mysql连接的状态，保证他能尽量练到固定的服务器，提高缓存效率
   3.线程池可能用不到负载分发
   4.要求均衡器支持TCP分发及TCP端口监测等等。
2. 负载均衡算法
   1.随机
   2.轮询 依次发送请求
   3.最少连接数
   4.最快响应
   5.哈希 对源IP进行hash
   6.权重
   7.排队，设置最大连接数。排队处理

### 3.3、一主多备间的负载均衡

1. 功能分区
   报表，分析，数据仓库，全文索引等
2. 过滤和数据分区
   通过复制的过滤功能，将不同的数据分配在不同的备库上
3. 保证备库跟上主库 MASTER_POS_WAIT()可以保证主库等待备库同步
4. 同步写操作， 有半同步机制

## 4、分片和分区的区别

Sharding 的思想是从分区的思想而来，但数据库分区基本上是数据对象级别的处理，比如表和索引的分区，每个子数据集上能够有不同的物理存储属性，还是单个数据库范围内的操作，而 **Sharding 是能够跨数据库，甚至跨越物理机器的**。

> MySQL5.1提供的分区(Partition)功能确实可以实现表的分区，但是这种**分区是局限在单个数据库范围里的，它不能跨越服务器的限制。**如果能够保证数据量很难超过现有数据库服务器的物理承载量，那么只需利用MySQL5.1提供的分区(Partition)功能来改善数据库性能即可；否则，还是考虑应用Sharding理念吧，spider storage engine就是一个不错的选择。

![]({{ site.url }}/assets/img/数据库/11.2.webp)