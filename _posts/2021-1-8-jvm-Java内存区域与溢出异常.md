---
title: jvm学习-Java内存区域与溢出异常
date: 2021-1-8 23:29:53
categories:
- Java基础
tags:
- Java基础
---

# JVM学习—Java内存区域与溢出异常

## 1、为什么要学习java内存区域？

​         作为一名java程序员在日常的工作中确实很少接触到内存管理的实际操作，因为在虚拟机的自动内存管理机制的帮助下，不再需要我们手动的去管理内存。不过，也正是因为我们将内存管理交给了虚拟机，**当出现内存泄漏等方面的问题，如果不了解虚拟机是怎样管理内存的，那排查错误将会是一件非常艰难的工作**。另外，要成为一名高级Java程序员，学好Java虚拟机方面的知识也是必不可少的。

## 2、运行时数据区域

​        Java虚拟机在执行Java程序的过程中会把它所管理的内存划分为若干个不同数据区域。如图所示：

​            ![]({{ site.url }}/assets/img/jvm/2.1.png)


​	 1、程序计数器

​           **程序计数器**是一块较小的内存空间，它的作用可以看做是当前线程所执行的字节码的行号指示器。为了在线程切换之后能恢复到原来正确的执行位置，每条线程都有一个独立的程序计数器来存储执行的字节码的行号。各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存，而且程序计数器也为唯一没有OutOfMemoryError情况的区域。

   2、Java虚拟机栈

​         Java虚拟机栈也是**线程私有**的。它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型，每个方法被调用的时候都会创建一个**栈帧**用于存储局部变量表、操作栈、动态链接、方法出口等信息。*每个方法被调用直至执行完成的过程，都对应一个栈帧在虚拟机栈中从入栈到出栈的过程。*对这个区域有两种**异常**情况：1、当线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常。如果虚拟机栈可以动态扩展，当扩展时无法申请到足够的内存时会抛出OutOfMemoryError异常。

3、本地方法栈

​      本地方法栈与虚拟机栈所发挥的作用类似，其区别不过是本地方法栈是为虚拟机执行Native方法服务。其也会抛出StackOverflowError和OutOfMemoryError异常。

4、Java堆

​     Java堆是Java虚拟机中所管理的内存中最大的一块。Java堆是被所有**线程共享**的一块内存区域，此区域的主要作用是**存放对象实例**。Java堆也是垃圾收集器管理的主要区域，从内存回收的角度来看，Java堆还可以被细分为：新生代和老年代，在细分一点还有Eden空间、From Survivor空间、To Survivor空间。Java堆可以处于物理上不连续的空间中，只要逻辑上连续即可。可以通过配置-Xmx和-Xms来扩展堆大小，如果堆无法再扩展将抛出OutOfMemoryError异常。

5、方法区

​    方法区也是**线程共享**的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即使编译器编译后的代码等数据。和堆一样不需要连续存储且可以选择连续存储或可扩展，在这个区域内存回收主要针对*常量池的回收*和对*类型的卸载*。当方法区无法申请到内存时会报OutOfMemoryError异常。

6、运行时常量池

​     运行时常量池是方法区的一部分，用于存放编译器生成的各种字面量和符号引用，这部分内容将在类加载后存放到方法区的运行时常量池中。当常量池无法申请到内存时会报OutOfMemoryError异常。

## 3、对象访问方式

​     假设下面这句代码：

​                 Object object=new Object()

​        根据之前的学习我们知道，“Object obj”这部分语义将会反应到Java栈的本地变量表中，作为一个reference类型数据出现 。而“new Object()”这部分的语义将会反映到Java堆中，另外Java堆中还必须能包含能查找到此**对象类型数据**（如对象类型、父类、实现的接口、方法等）的地址信息，这些类型数据存储在方法区中。**不同类型虚拟机可能访问对象的方式也不同**，主流的访问对象方式有两种：

​     1、使用句柄方式

​                Java堆中会划分一块内存来作为句柄池，reference中存储的就是对象的句柄地址，而句柄中包含了对象实例和数据类型各自的具体地址信息。

​             ![]({{ site.url }}/assets/img/jvm/2.2.png)


 2、直接指针访问方式

​              reference中直接存储就是对象地址，此方法的好处就是速度快。HotSpot虚拟机就用的这种方式。

​            ![]({{ site.url }}/assets/img/jvm/2.3.png)


## 4、思考题

1、对于对象类型数据的概念还是不太理解。



